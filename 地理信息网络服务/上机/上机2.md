# **上机软件环境**

操作系统：Windows10

API：百度地图

# 关键词搜索

## 加载地图

代码如下：

```js
//创建地图实例
var map = new BMapGL.Map("container");
//设置中心点
var centerPoint = new BMapGL.Point(117.151767, 34.221332);
//地图初始化，同时设置地图展示级别
map.centerAndZoom(centerPoint, 16);
//开启鼠标滚轮缩放
map.enableScrollWheelZoom(true);
```

界面如下：

![image-20220410102734292](C:\Users\10599\AppData\Roaming\Typora\typora-user-images\image-20220410102734292.png)

以中国矿业大学南湖校区为中心

## 搜索超市/博学楼

使用 searchNearby 函数根据中心点、半径与检索词发起周边检索。代码如下：

```js
// 本地关键词搜索
function searchKey(){
    // 清空之前所有搜索记录
    map.clearOverlays();
    // 清空路径规划结果
    var result = document.getElementById("routeResult");
    if (result!=null)
        result.innerHTML = '';
    // 获取关键词
    var keyWord = document.getElementById("search").value;
    var options = {
        renderOptions: {
            map: map,
            autoViewport: true,
            panel: "searchResult"
        }
    }
    var local =  new BMapGL.LocalSearch(map,options);
    local.searchNearby(keyWord, centerPoint, 900);
}
```

界面如下：

![image-20220410103500691](C:\Users\10599\AppData\Roaming\Typora\typora-user-images\image-20220410103500691.png)

搜索超市结果

## 路径规划

用户输入起点和终点，选择出行模式为步行，骑行或驾车（校内无公交）。选择规划方式为自动规划时，先进行搜索，把返回的第一个POI结果作为路线的起点和终点，输出结果；选择选点规划时，用户在本城市内选择合适的起点和终点，然后输出结果。结果列表将容器中进行展示，对驾车路线规划无效。

主要代码如下：

```js
function autoNevigation(){
    // 获取POI
    // 清空之前所有搜索记录
    map.clearOverlays();
    // 获取关键词
    var startKeyWord = document.getElementById("start").value;
    var endKeyWord = document.getElementById("end").value;

    var startPOI;
    var endPOI;

    var startOptions = {
        onSearchComplete: function (results) {
            // 判断状态是否正确
            if (startLocal.getStatus() == BMAP_STATUS_SUCCESS) {
                // 返回第一个搜索结果作为路径规划的起点
                startPOI = results.getPoi(0);
                console.log(startPOI);
                var endOptions = {
                    onSearchComplete: function (results) {
                        // 判断状态是否正确
                        if (endLocal.getStatus() == BMAP_STATUS_SUCCESS) {
                            // 返回第一个搜索结果作为路径规划的终点
                            endPOI = results.getPoi(0);
                            // console.log(endPOI);
                            var select = document.getElementById("routeSelect").value;
                            if (select == 'walking')
                                walkingRouteSearch(startPOI,endPOI);
                            else if (select == 'riding')
                                ridingRouteSearch(startPOI, endPOI);
                            else
                                drivingRouteSearch(startPOI,endPOI);
                        }
                    }
                }
                var endLocal =  new BMapGL.LocalSearch(map,endOptions);
                endLocal.searchNearby(endKeyWord, centerPoint, 1000);
            }
        }
    }
    // 本地半径查询
    var startLocal =  new BMapGL.LocalSearch(map,startOptions);
    startLocal.searchNearby(startKeyWord, centerPoint, 1000);

    // 骑行规划
    function ridingRouteSearch(startPOI, endPOI){
        // 清空搜索结果
        var result = document.getElementById("searchResult");
        if (result!=null)
            result.innerHTML = '';

        var riding = new BMapGL.RidingRoute(map, {
            renderOptions: {
                map: map,
                panel: "routeResult",
                autoViewport: true
            },
        });
        riding.search(startPOI, endPOI);
    }
    // 步行规划
    function walkingRouteSearch(startPOI, endPOI){
        // 清空搜索结果
        var result = document.getElementById("searchResult");
        if (result!=null)
            result.innerHTML = '';

        var walking = new BMapGL.WalkingRoute(map, {
            renderOptions: {
                map: map,
                panel: "routeResult",
                autoViewport: true
            },
        });
        walking.search(startPOI, endPOI);
    }
    //
    function drivingRouteSearch(startPOI, endPOI){
        // 清空搜索结果
        var result = document.getElementById("searchResult");
        if (result!=null)
            result.innerHTML = '';

        var driving = new BMapGL.DrivingRoute(map, {
            renderOptions:{
                map: map,
                panel: "routeResult",
                autoViewport: true
            }
        });
        driving.search(startPOI,endPOI);
    }
}
```

界面如下：

![image-20220410104706179](C:\Users\10599\AppData\Roaming\Typora\typora-user-images\image-20220410104706179.png)

一食堂步行到达环测学院大楼

![image-20220410104736454](C:\Users\10599\AppData\Roaming\Typora\typora-user-images\image-20220410104736454.png)

二食堂骑行到达环测学院大楼

![image-20220410104807110](C:\Users\10599\AppData\Roaming\Typora\typora-user-images\image-20220410104807110.png)

三食堂驾车到达环测学院大楼

# 实验小结

前期尝试了天地图API，发现不够大众化，超市搜索结果不够全面；同时腾讯地图API封装做得不好，调用比较麻烦；最后选择了百度地图API。利用API开发应先把功能写好，再考虑美化设计。最后，开发路径规划功能时遇到了回调地狱问题，这也是调用第三方API的一个弊端。本程序最大的特点就是不限制路径规划的输入，三种出行模式和两种规划模式都可以输出结果。

## 步骤

- 先拾取南湖坐标，保存坐标。
- 保存密钥，复制实例代码之后要记得修改密钥。复制代码记得把密钥那一行连同复制。
- 应先把功能写好，再考虑美化设计。

## 学长的代码

是把JS代码放在HTML中，路线规划获取地点和方式进行查询。但是查询范围有点问题。缩放也有点问题。

API参考

想办法找到检索返回的ROI

然后作为参数放入路线规划

![image-20220407204313626](C:\Users\10599\AppData\Roaming\Typora\typora-user-images\image-20220407204313626.png)